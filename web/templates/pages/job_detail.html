{{define "content"}}
{{if .error}}
<div class="text-center py-12">
    <h2 class="text-2xl font-bold text-white mb-2">Job Not Found</h2>
    <p class="text-gray-400">{{.error}}</p>
    <a href="/dashboard/jobs" class="mt-4 inline-block text-teal-400 hover:text-teal-300">Back to Jobs</a>
</div>
{{else}}
<div class="mb-8 flex items-center justify-between">
    <div>
        <a href="/dashboard/jobs" class="text-gray-400 hover:text-gray-200 text-sm mb-2 inline-block">&larr; Back to Jobs</a>
        <h2 class="text-3xl font-bold text-white">Job Detail</h2>
        <p class="text-gray-400 mt-1 font-mono">{{.job.ID}}</p>
    </div>
    <div class="flex gap-2">
        {{if or (eq (printf "%s" .job.Status) "pending") (eq (printf "%s" .job.Status) "scheduled") (eq (printf "%s" .job.Status) "running")}}
        <button onclick="cancelJob('{{.job.ID}}')" class="px-4 py-2 bg-red-500/10 text-red-400 rounded-lg text-sm hover:bg-red-500/20 transition">Cancel</button>
        {{end}}
        {{if or (eq (printf "%s" .job.Status) "failed") (eq (printf "%s" .job.Status) "dead")}}
        <button onclick="retryJob('{{.job.ID}}')" class="px-4 py-2 bg-teal-500 text-white rounded-lg text-sm hover:bg-teal-600 transition">Retry</button>
        {{end}}
    </div>
</div>

<!-- Job Info -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-dark-800 rounded-xl border border-gray-700/50 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Job Information</h3>
        <dl class="space-y-3">
            <div class="flex justify-between">
                <dt class="text-gray-400">Type</dt>
                <dd class="text-white font-mono">{{.job.Type}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Status</dt>
                <dd>
                    <span id="job-status" class="px-2 py-1 text-xs rounded-full {{statusBadge (printf "%s" .job.Status)}}">{{upper (printf "%s" .job.Status)}}</span>
                </dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Priority</dt>
                <dd>
                    <span class="px-2 py-1 text-xs rounded-full {{priorityBadge .job.Priority}}">{{.job.Priority.String}}</span>
                </dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Queue</dt>
                <dd class="text-white font-mono text-sm">{{.job.Queue}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Worker</dt>
                <dd class="text-white">{{if .job.WorkerID}}{{.job.WorkerID}}{{else}}-{{end}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Retries</dt>
                <dd class="text-white">{{.job.RetryCount}} / {{.job.MaxRetries}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Timeout</dt>
                <dd class="text-white">{{.job.Timeout}}</dd>
            </div>
        </dl>
    </div>

    <div class="bg-dark-800 rounded-xl border border-gray-700/50 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Timeline</h3>
        <dl class="space-y-3">
            <div class="flex justify-between">
                <dt class="text-gray-400">Created</dt>
                <dd class="text-white">{{formatTime .job.CreatedAt}}</dd>
            </div>
            {{if not .job.ScheduledAt.IsZero}}
            <div class="flex justify-between">
                <dt class="text-gray-400">Scheduled</dt>
                <dd class="text-white">{{formatTime .job.ScheduledAt}}</dd>
            </div>
            {{end}}
            <div class="flex justify-between">
                <dt class="text-gray-400">Started</dt>
                <dd class="text-white">{{formatTimePtr .job.StartedAt}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Completed</dt>
                <dd class="text-white">{{formatTimePtr .job.CompletedAt}}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Duration</dt>
                <dd class="text-white">{{formatDuration .job.CompletedAt .job.StartedAt}}</dd>
            </div>
        </dl>

        {{if .job.Error}}
        <div class="mt-6 pt-4 border-t border-gray-700/50">
            <h4 class="text-sm font-medium text-red-400 mb-2">Error</h4>
            <pre class="text-sm text-red-300 bg-red-500/5 p-3 rounded-lg overflow-x-auto">{{.job.Error}}</pre>
        </div>
        {{end}}
    </div>
</div>

<!-- Payload & Result -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <div class="bg-dark-800 rounded-xl border border-gray-700/50 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Payload</h3>
        <pre class="text-sm text-gray-300 bg-dark-900 p-4 rounded-lg overflow-x-auto">{{json .job.Payload}}</pre>
    </div>

    {{if .job.Result}}
    <div class="bg-dark-800 rounded-xl border border-gray-700/50 p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Result</h3>
        <pre class="text-sm text-gray-300 bg-dark-900 p-4 rounded-lg overflow-x-auto">{{json .job.Result}}</pre>
    </div>
    {{end}}
</div>

<script>
function cancelJob(id) {
    if (!confirm('Cancel this job?')) return;
    fetch('/api/v1/jobs/' + id, { method: 'DELETE' })
        .then(r => r.json())
        .then(() => location.reload());
}
function retryJob(id) {
    fetch('/api/v1/jobs/' + id + '/retry', { method: 'POST' })
        .then(r => r.json())
        .then(() => location.reload());
}
</script>
{{end}}
{{end}}
